(()=>{"use strict";var e={957:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.App=t.StoreContext=void 0;const o=r(997),n=r(689),i=r(218),a=r(547),s=r(606);t.StoreContext=(0,n.createContext)((0,i.createStore)()),t.App=()=>{const{bot:e}=(0,a.useBotContext)(),r=(0,i.createStore)();return(0,n.useEffect)((()=>{e&&r.addBot(e)}),[e,r]),(0,o.jsx)(t.StoreContext.Provider,{value:r,children:(0,o.jsx)(a.Router,{children:(0,o.jsx)(a.Route,{path:"/start",children:(0,o.jsx)(s.StartScreen,{})})})})}},421:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.dbAuth=t.db=void 0;const n=r(496);o(r(142)).default.config();const{PGDATABASE:i,PGUSER:a,PGPASSWORD:s,PGHOST:l,PGPORT:c}=process.env;t.db=new n.Sequelize(i,a,s,{host:l,port:Number(c),dialect:"postgres",dialectOptions:{ssl:{rejectUnauthorized:!1}}}),t.dbAuth=async()=>{try{await t.db.authenticate(),await t.db.sync()}catch(e){console.log(e)}}},893:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.User=void 0;const o=r(421),n=r(496);t.User=o.db.define("User",{id:{type:n.DataTypes.INTEGER,primaryKey:!0},is_ordered_paid_key:{type:n.DataTypes.BOOLEAN,defaultValue:!1},is_ordered_key:{type:n.DataTypes.BOOLEAN,defaultValue:!1},email:{type:n.DataTypes.STRING,defaultValue:null},first_name:{type:n.DataTypes.STRING,defaultValue:null},last_name:{type:n.DataTypes.STRING,defaultValue:null},phone_number:{type:n.DataTypes.STRING,defaultValue:null},is_staff:{type:n.DataTypes.INTEGER,defaultValue:0},is_active:{type:n.DataTypes.INTEGER,defaultValue:0},chatID:{type:n.DataTypes.STRING,defaultValue:null},inviteLink:{type:n.DataTypes.STRING,defaultValue:null}},{timestamps:!1})},65:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.setupBotListeners=void 0,t.setupBotListeners=e=>{e.client.on("message",(async t=>{try{const{chat:r,message_id:o,text:n}=t;if("/start"!==n&&await e.client.deleteMessage(t.chat.id,String(t.message_id)),null!=n){const t=await e.client.editMessageText(n,{chat_id:r.id,message_id:o});if("boolean"!=typeof t&&t.text===n)return void console.log("Message content is the same. Skipping edit.")}}catch(e){console.error()}})),e.client.on("polling_error",console.log),e.client.on("error",console.log)}},63:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createInviteLink=void 0;const n=o(r(167)),{TELEGRAM_TOKEN:i,CHANNEL_ID:a}=process.env;t.createInviteLink=async function(){let e=null,t=0;for(;t<3;){try{const t=await n.default.get(`https://api.telegram.org/bot${i}/createChatInviteLink`,{params:{chat_id:a,member_limit:1},headers:{"Content-Type":"application/json"}});if(200===t.status){const r=t.data;if(r.ok&&r.result.invite_link){e=r.result.invite_link;break}console.error("Failed to create invite link:",r.description)}else console.error("Failed to create invite link:",t.statusText)}catch(e){console.error("Error:",e)}t++,t<3&&await new Promise((e=>setTimeout(e,2e3)))}return e||console.error("Max retry attempts reached. Unable to create invite link."),e}},29:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.useStore=t.lazyInject=t.provide=t.container=void 0,r(236);const o=r(455),n=r(767),i=r(689),a=new o.Container({autoBindInjectable:!0,defaultScope:"Singleton"});t.container=a;const s={singleton:()=>e=>(0,n.fluentProvide)(e).inSingletonScope().done()(e),transient:()=>e=>(0,n.fluentProvide)(e).inTransientScope().done()(e)};t.provide=s;function l(e){const t=(Reflect.getMetadata("diversify-binding-decorators:provide",Reflect)||[]).filter((t=>t.implementationType===e));if(0===t.length)throw new Error(`Provided identifier isn't registered: ${e.toString()}`);a.load(new o.ContainerModule((e=>{t.forEach((t=>t.constraint(e,t.implementationType)))})))}t.lazyInject=e=>(t,r,o)=>{if(!e)throw new Error(`Incorrect identifier provided: ${e}`);a.isBound(e)||l(e),o?o.initializer=()=>a.get(e):Object.defineProperty(t,r,{get:()=>a.get(e),enumerable:!0})},t.useStore=function(e){return(0,i.useMemo)((()=>(a.isBound(e)||l(e),a.get(e))),[e])}},560:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=r(997),i=r(266),a=r(547),s=o(r(142)),l=r(957);(0,r(421).dbAuth)(),s.default.config();const{TELEGRAM_TOKEN:c,PORT:d}=process.env;if(console.log("Bot mode: ","production"),!c)throw new Error("Provide TELEGRAM_TOKEN to .env https://core.telegram.org/bots#6-botfather");const u=new i.UrbanBotTelegram({token:c,isPolling:!1});(0,a.render)((0,n.jsx)(a.Root,{isNewMessageEveryRender:!1,bot:u,port:d?Number(d):void 0,children:(0,n.jsx)(l.App,{})}),(()=>console.log("telegram bot has started")))},606:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StartScreen=void 0;const o=r(997),n=r(944),i=r(547),a=r(689),s=r(957),l=r(63);t.StartScreen=(0,n.observer)((()=>{const{findUser:e,updateUser:t}=(0,a.useContext)(s.StoreContext),[r,n]=(0,a.useState)(void 0);return(0,i.useContact)((({from:r,phoneNumber:o})=>{e(`+${o}`).then((async e=>{if(e)try{if(e.inviteLink)n(`Аутентификация пройдена, добро пожаловать в ATOM Insider. \nВнимание - <a href='${e.inviteLink}'>ссылку</a> можно использовать лишь один раз.`);else{const o=await(0,l.createInviteLink)();await t(e.phone_number,o,Number(r.id)),n(`Аутентификация пройдена, добро пожаловать в ATOM Insider. \nВнимание - <a href='${o}'>ссылку</a> можно использовать лишь один раз.`)}}catch(e){n("Что-то пошло не так, нажмите /start"),console.error("Error:",e)}else n("Владелец с вашим номером не найден. Если вы являетесь держателем бронирования и не можете попасть в канал, обратитесь в @atom_support_bot и укажите телефон указанный при регистрации, а также адрес электронной почты.")})).catch((e=>{n("Что-то пошло не так, нажмите /start"),console.error("Error:",e)}))})),r?(0,o.jsx)(i.Text,{parseMode:"HTML",children:r}):(0,o.jsx)(i.ButtonGroup,{parseMode:"HTML",title:"Чтобы пройти аутентификацию и получить одноразовую ссылку-приглашение нажмите <b>далее</b>",isReplyButtons:!0,isResizedKeyboard:!0,children:(0,o.jsx)(i.Button,{style:"PRIMARY",request_contact:!0,children:"далее"})})}))},218:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,a=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,r,a):n(t,r))||a);return i>3&&a&&Object.defineProperty(t,r,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.createStore=t.UserStore=void 0;const n=r(29),i=r(211),a=r(893),s=r(65);let l=class{constructor(){this.updateUser=async(e,t,r)=>{await a.User.update({chatID:r,inviteLink:t},{where:{phone_number:e}})},this.addBot=async e=>{(0,s.setupBotListeners)(e)},(0,i.makeAutoObservable)(this)}async findUser(e){return await a.User.findOne({where:{phone_number:e,is_ordered_paid_key:!0}})}};o([i.action],l.prototype,"findUser",null),o([i.action],l.prototype,"updateUser",void 0),o([i.action],l.prototype,"addBot",void 0),l=o([n.provide.singleton()],l),t.UserStore=l,t.createStore=()=>new l},547:e=>{e.exports=require("@urban-bot/core")},266:e=>{e.exports=require("@urban-bot/telegram")},167:e=>{e.exports=require("axios")},142:e=>{e.exports=require("dotenv")},455:e=>{e.exports=require("inversify")},767:e=>{e.exports=require("inversify-binding-decorators")},211:e=>{e.exports=require("mobx")},944:e=>{e.exports=require("mobx-react-lite")},689:e=>{e.exports=require("react")},997:e=>{e.exports=require("react/jsx-runtime")},236:e=>{e.exports=require("reflect-metadata")},496:e=>{e.exports=require("sequelize")}},t={};!function r(o){var n=t[o];if(void 0!==n)return n.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,r),i.exports}(560)})();